<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OceanView Admin - Users</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="assets/css/oceanview-dashboard.css" rel="stylesheet">
</head>

<body>



<div id="sidebarMount"></div>


<div class="main-content">

  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="fas fa-users-gear me-2 text-primary"></i>Users
    </h1>

    <div class="d-flex align-items-center">
      <span class="badge bg-success me-2">Online</span>
      <span class="me-3">Jan 22, 2026</span>
      <i class="fas fa-bell fs-5 text-muted"></i>
    </div>
  </header>

  <div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">User Management</h5>

      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary" onclick="loadUsers()">
          <i class="fas fa-rotate me-1"></i> Refresh
        </button>
        <button type="button" class="btn btn-primary" onclick="openCreateUserModal()">
          <i class="fas fa-plus me-1"></i> New User
        </button>
      </div>
    </div>

    <div class="alert alert-danger py-2" id="pageError" style="display:none;"></div>

    <div class="table-responsive">
      <table class="table table-striped align-middle" id="usersTable">
        <thead>
          <tr>
            <th style="width:80px;">ID</th>
            <th>Username</th>
            <th style="width:140px;">Role</th>
            <th style="width:140px;">Status</th>
            <th class="text-end" style="width:160px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="5">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="userModalTitle">New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="userId">

        <div class="mb-2">
          <label class="form-label">Username</label>
          <input class="form-control" id="username" placeholder="ex: admin1">
        </div>

        <div class="mb-2">
          <label class="form-label">Role</label>
          <select class="form-select" id="role">
            <option value="ADMIN">ADMIN</option>
            <option value="STAFF">STAFF</option>
            <option value="GUEST">GUEST</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Status</label>
          <select class="form-select" id="status">
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Password (Create / Reset only)</label>
          <input class="form-control" id="password" type="password" placeholder="Leave empty to keep unchanged">
          <div class="form-text">For create, password required. For edit, leave empty to keep old password.</div>
        </div>

        <div class="text-danger small" id="userError" style="display:none;"></div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveUser()">Save</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/oceanview-dashboard.js"></script>

<script>
  const BASE = "/OceanViewResortBooking";
  const modal = new bootstrap.Modal(document.getElementById("userModal"));
  const tbody = document.querySelector("#usersTable tbody");

  function showPageError(msg) {
    const el = document.getElementById("pageError");
    el.style.display = "block";
    el.textContent = msg;
  }
  function hidePageError() {
    const el = document.getElementById("pageError");
    el.style.display = "none";
    el.textContent = "";
  }
  function showModalError(msg) {
    const el = document.getElementById("userError");
    el.style.display = "block";
    el.textContent = msg;
  }
  function hideModalError() {
    const el = document.getElementById("userError");
    el.style.display = "none";
    el.textContent = "";
  }
  function esc(s) {
    return String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  async function loadUsers() {
    hidePageError();
    tbody.innerHTML = `<tr><td colspan="5">Loading...</td></tr>`;

    try {
      const res = await fetch(`${BASE}/api/users`, { credentials: "same-origin" });
      const txt = await res.text();

      if (!res.ok) {
        let msg = "Cannot load users";
        try { msg = JSON.parse(txt).message || msg; } catch(e) {}
        tbody.innerHTML = `<tr><td colspan="5" class="text-danger">${esc(msg)}</td></tr>`;
        return;
      }

      const data = JSON.parse(txt);
      const users = data.users || [];

      if (!users.length) {
        tbody.innerHTML = `<tr><td colspan="5">No users found.</td></tr>`;
        return;
      }

      tbody.innerHTML = users.map(u => `
        <tr>
          <td>${u.userId}</td>
          <td>${esc(u.username)}</td>
          <td><span class="badge bg-primary">${esc(u.role)}</span></td>
          <td>
            ${u.status === "ACTIVE"
              ? `<span class="badge bg-success">ACTIVE</span>`
              : `<span class="badge bg-secondary">INACTIVE</span>`}
          </td>
          <td class="text-end">
            <button type="button" class="btn btn-sm btn-outline-primary me-1"
              onclick='openEditUserModal(${JSON.stringify(u)})'>
              <i class="fas fa-pen"></i>
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger"
              onclick="deleteUser(${u.userId})">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `).join("");

    } catch (err) {
      showPageError("Error: " + err.message);
      tbody.innerHTML = `<tr><td colspan="5" class="text-danger">Error loading data</td></tr>`;
    }
  }

  function openCreateUserModal() {
    document.getElementById("userModalTitle").textContent = "New User";
    document.getElementById("userId").value = "";
    document.getElementById("username").value = "";
    document.getElementById("role").value = "STAFF";
    document.getElementById("status").value = "ACTIVE";
    document.getElementById("password").value = "";
    hideModalError();
    modal.show();
  }

  function openEditUserModal(u) {
    document.getElementById("userModalTitle").textContent = "Edit User";
    document.getElementById("userId").value = u.userId;
    document.getElementById("username").value = u.username || "";
    document.getElementById("role").value = u.role || "STAFF";
    document.getElementById("status").value = u.status || "ACTIVE";
    document.getElementById("password").value = "";
    hideModalError();
    modal.show();
  }

  async function saveUser() {
    hideModalError();

    const id = document.getElementById("userId").value.trim();
    const username = document.getElementById("username").value.trim();
    const role = document.getElementById("role").value.trim();
    const status = document.getElementById("status").value.trim();
    const password = document.getElementById("password").value;

    if (!username) return showModalError("Username is required");

    try {
      // CREATE
      if (!id) {
        if (!password || password.trim().length < 3) return showModalError("Password required (min 3 chars)");

        const res = await fetch(`${BASE}/api/users`, {
          method: "POST",
          credentials: "same-origin",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, password, role })
        });

        const txt = await res.text();
        if (!res.ok) {
          let msg = "Create failed";
          try { msg = JSON.parse(txt).message || msg; } catch(e) {}
          return showModalError(msg);
        }

        modal.hide();
        loadUsers();
        return;
      }

      // UPDATE
      const payload = { userId: Number(id), username, role, status };
      if (password && password.trim() !== "") payload.newPassword = password.trim();

      const res = await fetch(`${BASE}/api/users`, {
        method: "PUT",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const txt = await res.text();
      if (!res.ok) {
        let msg = "Update failed";
        try { msg = JSON.parse(txt).message || msg; } catch(e) {}
        return showModalError(msg);
      }

      modal.hide();
      loadUsers();

    } catch (err) {
      showModalError(err.message);
    }
  }

  async function deleteUser(userId) {
    if (!confirm("Delete this user?")) return;

    try {
      const res = await fetch(`${BASE}/api/users?id=${encodeURIComponent(userId)}`, {
        method: "DELETE",
        credentials: "same-origin"
      });

      const txt = await res.text();
      if (!res.ok) {
        let msg = "Delete failed";
        try { msg = JSON.parse(txt).message || msg; } catch(e) {}
        alert(msg);
        return;
      }

      loadUsers();
    } catch (err) {
      alert(err.message);
    }
  }

  window.loadUsers = loadUsers;
  window.openCreateUserModal = openCreateUserModal;
  window.openEditUserModal = openEditUserModal;
  window.saveUser = saveUser;
  window.deleteUser = deleteUser;

  document.addEventListener("DOMContentLoaded", loadUsers);
</script>
<script src="assets/js/layout.js"></script>

</body>

</html>
