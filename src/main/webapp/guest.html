<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OceanView - Guests</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="assets/css/oceanview-dashboard.css" rel="stylesheet">
</head>
<body>


<div id="sidebarMount"></div>

<div class="main-content">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="fas fa-users me-2 text-primary"></i>Guests
    </h1>

    <div class="d-flex gap-2 align-items-center">
      <input id="q" class="form-control form-control-sm" style="max-width:260px" placeholder="Search name/email/phone">
      <button class="btn btn-outline-secondary btn-sm" onclick="loadGuests()">
        <i class="fas fa-rotate me-1"></i>Refresh
      </button>
      <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#guestModal" onclick="openCreate()">
        <i class="fas fa-plus me-1"></i>New Guest
      </button>
    </div>
  </header>

  <div id="pageAlertWrap" style="display:none;" class="mb-3">
    <div class="alert alert-dismissible fade show" role="alert" id="pageAlert">
      <span id="pageAlertMsg"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  </div>

  <div class="card p-3 border-0 shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle" id="guestTable">
        <thead class="table-light">
          <tr>
            <th>ID</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Address</th>
            <th>Contact</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td colspan="6" class="text-muted">Loading...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal fade" id="guestModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title" id="guestModalTitle">
          <i class="fas fa-user-plus me-2 text-primary"></i>New Guest
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="guestId">

        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Full Name</label>
            <input class="form-control" id="fullName" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Email</label>
            <input class="form-control" id="email" type="email">
          </div>

          <div class="col-md-6">
            <label class="form-label">Contact Number</label>
            <input class="form-control" id="contactNumber" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Address</label>
            <input class="form-control" id="address">
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-primary" onclick="saveGuest()">Save</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="assets/js/oceanview-dashboard.js"></script>
<script src="assets/js/layout.js"></script>

<script>
const ctx = "/" + window.location.pathname.split("/")[1];

function showAlert(msg, type="success") {
  const wrap = document.getElementById("pageAlertWrap");
  const alert = document.getElementById("pageAlert");
  const txt = document.getElementById("pageAlertMsg");
  txt.textContent = msg;
  alert.className = "alert alert-" + type + " alert-dismissible fade show";
  wrap.style.display = "block";
}

async function loadGuests() {
  const q = document.getElementById("q").value.trim();
  const url = q
    ? ctx + "/api/guests/search?q=" + encodeURIComponent(q)
    : ctx + "/api/guests";

  const res = await fetch(url, { credentials: "include" });
  const data = await res.json();

  const tbody = document.querySelector("#guestTable tbody");
  tbody.innerHTML = "";

  if (!data.success) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-danger">${data.message || "Failed"}</td></tr>`;
    return;
  }

  const guests = data.guests || [];
  if (guests.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-muted">No guests found.</td></tr>`;
    return;
  }

  guests.forEach(g => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${g.guestId}</td>
      <td>${escapeHtml(g.fullName)}</td>
      <td>${escapeHtml(g.email || "")}</td>
      <td>${escapeHtml(g.address || "")}</td>
      <td>${escapeHtml(g.contactNumber || "")}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="openEdit(${g.guestId})">
          <i class="fas fa-pen"></i>
        </button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteGuest(${g.guestId})">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function escapeHtml(s) {
  return (s || "").toString()
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function openCreate() {
  document.getElementById("guestModalTitle").innerHTML =
    '<i class="fas fa-user-plus me-2 text-primary"></i>New Guest';
  document.getElementById("guestId").value = "";
  document.getElementById("fullName").value = "";
  document.getElementById("email").value = "";
  document.getElementById("contactNumber").value = "";
  document.getElementById("address").value = "";
}

async function openEdit(id) {
  const res = await fetch(ctx + "/api/guests/detail?id=" + id, { credentials: "include" });
  const data = await res.json();

  if (!data.success) {
    showAlert(data.message || "Failed to load guest", "danger");
    return;
  }

  const g = data.guest;
  document.getElementById("guestModalTitle").innerHTML =
    '<i class="fas fa-user-pen me-2 text-primary"></i>Edit Guest';
  document.getElementById("guestId").value = g.guestId;
  document.getElementById("fullName").value = g.fullName || "";
  document.getElementById("email").value = g.email || "";
  document.getElementById("contactNumber").value = g.contactNumber || "";
  document.getElementById("address").value = g.address || "";

  new bootstrap.Modal(document.getElementById("guestModal")).show();
}

async function saveGuest() {
  const guestId = document.getElementById("guestId").value.trim();

  const payload = {
    guestId: guestId ? parseInt(guestId) : undefined,
    fullName: document.getElementById("fullName").value.trim(),
    email: document.getElementById("email").value.trim(),
    contactNumber: document.getElementById("contactNumber").value.trim(),
    address: document.getElementById("address").value.trim()
  };

  if (!payload.fullName) return showAlert("Full name required", "danger");
  if (!payload.contactNumber) return showAlert("Contact number required", "danger");

  const res = await fetch(ctx + "/api/guests", {
    method: guestId ? "PUT" : "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (!data.success) {
    showAlert(data.message || "Save failed", "danger");
    return;
  }

  showAlert(guestId ? "Guest updated!" : "Guest created!");
  bootstrap.Modal.getInstance(document.getElementById("guestModal")).hide();
  loadGuests();
}

async function deleteGuest(id) {
  if (!confirm("Delete this guest?")) return;

  const res = await fetch(ctx + "/api/guests?id=" + id, {
    method: "DELETE",
    credentials: "include"
  });

  const data = await res.json();
  if (!data.success) {
    showAlert(data.message || "Delete failed", "danger");
    return;
  }

  showAlert("Guest deleted!");
  loadGuests();
}

let t;
document.getElementById("q").addEventListener("input", () => {
  clearTimeout(t);
  t = setTimeout(loadGuests, 250);
});

loadGuests();
</script>
</body>
</html>
