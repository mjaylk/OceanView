<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OceanView - Reservations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="assets/css/oceanview-dashboard.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.css">
  <style>
    /* Optional: slightly nicer calendar spacing */
    #bookingsCalendar .fc .fc-toolbar-title { font-size: 1.1rem; }
    #bookingsCalendar .fc-daygrid-event { cursor: pointer; }
  </style>
</head>
<body>

<button class="toggle-sidebar" onclick="toggleSidebar()">
  <i class="fas fa-bars fs-5"></i>
</button>

<nav class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div class="logo-section">
      <div class="logo-icon"><i class="fas fa-water-wave"></i></div>
      <div>
        <h4 class="sidebar-title mb-0">OceanView</h4>
        <p class="sidebar-subtitle mb-0">Admin Panel</p>
      </div>
    </div>
  </div>
  <div class="nav-section">
    <ul class="nav flex-column list-unstyled px-2">
      <li class="nav-item">
        <a class="nav-link" href="admin.html"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="reservation.html"><i class="fas fa-calendar-check"></i><span>Reservations</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="users.html"><i class="fas fa-users-gear"></i><span>Users</span></a>
      </li>
    </ul>
  </div>
  <a class="nav-link logout-link text-warning" href="/OceanViewResortBooking/api/logout">
    <i class="fas fa-sign-out-alt"></i><span>Logout</span>
  </a>
</nav>

<div class="main-content">
  <header class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
      <i class="fas fa-calendar-check me-2 text-primary"></i>Reservations
    </h1>
    <div class="d-flex align-items-center gap-2">
      <span class="badge bg-success">Online</span>
      <span id="todayLabel" class="text-muted"></span>
      <button class="btn btn-primary btn-sm"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#reservationModal"
              onclick="openNewReservationModal()">
        <i class="fas fa-plus me-1"></i>New Reservation
      </button>
    </div>
  </header>

  <div id="pageAlertWrap" style="display:none;" class="mb-3">
    <div class="alert alert-dismissible fade show" role="alert" id="pageAlert">
      <i class="fas fa-triangle-exclamation me-2"></i>
      <span id="pageAlertMsg"></span>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card p-3 border-0 shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Reservations</h5>
      <button class="btn btn-outline-secondary btn-sm" type="button" onclick="loadReservations()">
        <i class="fas fa-rotate me-1"></i>Refresh
      </button>
    </div>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="resTable">
        <thead class="table-light">
        <tr>
          <th>ID</th>
          <th>Guest</th>
          <th>Email</th>
          <th>Room</th>
          <th>Check-in</th>
          <th>Check-out</th>
          <th>Status</th>
          <th class="text-end">Total</th>
          <th class="text-end">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr><td colspan="9" class="text-muted">No data loaded yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- CALENDAR + CARDS -->
  <div class="row g-3 mt-3">
    <div class="col-lg-8">
      <div class="card p-3 border-0 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Bookings Calendar</h5>
          <small class="text-muted">Hover a booking to see details</small>
        </div>
        <div id="bookingsCalendar"></div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card p-3 border-0 shadow-sm">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Recent Check-ins</h5>
          <small class="text-muted" id="checkInCount">0</small>
        </div>
        <div id="recentCheckins" class="d-grid gap-2"></div>
      </div>
    </div>
  </div>

</div>

<!-- CREATE/EDIT MODAL -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-sm">

      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalTitle"><i class="fas fa-calendar-plus me-2 text-primary"></i>New Reservation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div id="formAlertWrap" style="display:none;">
          <div class="alert alert-dismissible fade show" role="alert" id="formAlert">
            <i class="fas fa-circle-info me-2"></i>
            <span id="formAlertMsg"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        </div>

        <form id="reservationForm" class="row g-3">
          <input type="hidden" id="reservationId" value="">

          <div class="col-12">
            <label class="form-label">Find Guest (email / phone / name)</label>
            <input type="text" class="form-control" id="guestSearch"
                   list="guestSuggestions"
                   placeholder="Start typing..."
                   autocomplete="off">
            <datalist id="guestSuggestions"></datalist>
            <div class="form-text">Select a suggestion to auto-fill guest details.</div>
            <input type="hidden" id="guestId" value="">
          </div>

          <div class="col-md-12">
            <label class="form-label">Guest Name</label>
            <input type="text" class="form-control" id="guestName" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Guest Email</label>
            <input type="email" class="form-control" id="guestEmail" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Guest Contact Number</label>
            <input type="text" class="form-control" id="guestContactNumber" required>
          </div>

          <div class="col-md-8">
            <label class="form-label">Room</label>
            <select class="form-select" id="roomId" required>
              <option value="">Loading rooms...</option>
            </select>
            <div class="form-text" id="roomMeta"></div>
            <div class="form-text text-muted" id="roomBlockedHint"></div>
          </div>

          <div class="col-md-4">
            <label class="form-label">Guests</label>
            <input type="number" class="form-control" id="guestCount" min="1" value="1" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Check-in Date</label>
            <input type="date" class="form-control" id="checkIn" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Check-out Date</label>
            <input type="date" class="form-control" id="checkOut" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Status</label>
            <select class="form-select" id="status" required>
              <option value="PENDING">Pending</option>
              <option value="CONFIRMED">Confirmed</option>
              <option value="CHECKED_IN">Checked-in</option>
            </select>
          </div>

          <div class="col-12"><hr class="my-2"></div>

          <div class="col-md-3">
            <label class="form-label">Nights</label>
            <input type="text" class="form-control" id="calcNights" readonly>
          </div>

          <div class="col-md-3">
            <label class="form-label">Rate / Night</label>
            <input type="text" class="form-control" id="calcRate" readonly>
          </div>

          <div class="col-md-3">
            <label class="form-label">Subtotal</label>
            <input type="text" class="form-control" id="calcSubtotal" readonly>
          </div>

          <div class="col-md-3">
            <label class="form-label">Total</label>
            <input type="text" class="form-control fw-semibold" id="calcTotal" readonly>
          </div>

          <div class="col-12">
            <label class="form-label">Special Requests</label>
            <textarea class="form-control" id="notes" rows="3"></textarea>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" onclick="resetReservationForm()">Clear</button>
        <button type="button" class="btn btn-primary" id="btnSave" onclick="saveReservation()">
          <span class="me-2" id="btnSaveSpinner" style="display:none;">
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          </span>
          Save Reservation
        </button>
      </div>

    </div>
  </div>
</div>

<!-- VIEW MODAL -->
<div class="modal fade" id="viewReservationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content border-0 shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-receipt me-2 text-muted"></i>Reservation Details
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
          <div>
            <div class="text-muted small">Reservation Number</div>
            <div class="fs-5 fw-semibold" id="vReservationNumber">-</div>
          </div>
          <div class="text-end">
            <div class="text-muted small">Status</div>
            <span class="badge text-bg-secondary" id="vStatus">-</span>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-md-6">
            <div class="border rounded-3 p-3 h-100">
              <div class="text-muted small mb-2">Guest</div>
              <div class="fw-semibold" id="vGuestName">-</div>
              <div class="text-muted small" id="vGuestEmail">-</div>
              <div class="text-muted small" id="vGuestPhone">-</div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="border rounded-3 p-3 h-100">
              <div class="text-muted small mb-2">Room</div>
              <div class="fw-semibold" id="vRoomNumber">-</div>
              <div class="text-muted small" id="vDates">-</div>
              <div class="text-muted small" id="vNights">-</div>
            </div>
          </div>

          <div class="col-12">
            <div class="border rounded-3 p-3">
              <div class="text-muted small mb-2">Pricing</div>
              <div class="row g-2">
                <div class="col-md-3">
                  <div class="text-muted small">Rate / Night</div>
                  <div class="fw-semibold" id="vRate">-</div>
                </div>
                <div class="col-md-3">
                  <div class="text-muted small">Subtotal</div>
                  <div class="fw-semibold" id="vSubtotal">-</div>
                </div>
                <div class="col-md-3">
                  <div class="text-muted small">Tax</div>
                  <div class="fw-semibold" id="vTax">-</div>
                </div>
                <div class="col-md-3">
                  <div class="text-muted small">Total</div>
                  <div class="fw-semibold" id="vTotal">-</div>
                </div>
              </div>
              <div class="text-muted small mt-2" id="vDiscount">-</div>
            </div>
          </div>

          <div class="col-12">
            <div class="text-muted small mb-1">Notes</div>
            <div class="border rounded-3 p-3" id="vNotes">-</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        <button class="btn btn-outline-secondary" id="vEditBtn" type="button">Edit</button>
        <button class="btn btn-outline-danger" id="vDeleteBtn" type="button">Delete</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js"></script>
<script src="assets/js/oceanview-dashboard.js"></script>

<script>
  const BASE = "/OceanViewResortBooking";
  const tbody = document.querySelector("#resTable tbody");
  const roomsById = new Map();

  let guestSearchTimer = null;
  let lastGuestResults = [];
  let bookedRanges = [];
  let reservationsCache = [];
  let calendar = null;

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("todayLabel").textContent = new Date().toLocaleDateString();
    loadReservations();
    initCalendarIfNeeded();
  });

  function showAlert(scope, message, level = "danger") {
    const wrap = document.getElementById(scope + "AlertWrap");
    const alert = document.getElementById(scope + "Alert");
    const msg = document.getElementById(scope + "AlertMsg");
    wrap.style.display = "block";
    alert.className = `alert alert-${level} alert-dismissible fade show`;
    msg.textContent = message;
  }
  function hideAlert(scope) { document.getElementById(scope + "AlertWrap").style.display = "none"; }

  function setSaving(isSaving) {
    document.getElementById("btnSave").disabled = isSaving;
    document.getElementById("btnSaveSpinner").style.display = isSaving ? "inline-block" : "none";
  }

  function todayIso() { return new Date().toISOString().slice(0, 10); }
  function money(v) { const n = Number(v || 0); return "$" + n.toFixed(2); }

  function setStatusBadge(el, status) {
    const s = String(status || "").toUpperCase();
    el.textContent = s || "-";
    el.className = "badge " + (
      s === "CONFIRMED" ? "text-bg-success" :
      s === "PENDING" ? "text-bg-warning" :
      s === "CHECKED_IN" ? "text-bg-info" :
      "text-bg-secondary"
    );
  }

  function openNewReservationModal() {
    resetReservationForm();
    document.getElementById("reservationModalTitle").innerHTML =
      `<i class="fas fa-calendar-plus me-2 text-primary"></i>New Reservation`;
    loadRoomsDropdown();
    initGuestSearch();
    lockPastDates();
  }

  function resetReservationForm() {
    document.getElementById("reservationForm").reset();
    document.getElementById("reservationId").value = "";
    document.getElementById("guestId").value = "";
    document.getElementById("roomMeta").textContent = "";
    document.getElementById("roomBlockedHint").textContent = "";
    document.getElementById("guestSuggestions").innerHTML = "";
    bookedRanges = [];
    hideAlert("form");
    renderCalc({ nights: "", rate: "", subtotal: "", total: "" });
  }

  function lockPastDates() {
    const min = todayIso();
    document.getElementById("checkIn").min = min;
    document.getElementById("checkOut").min = min;
  }

  function parseIsoDate(s) {
    const [y,m,d] = s.split("-").map(Number);
    return new Date(y, m-1, d);
  }

  function overlaps(startIso, endIso, range) {
    const s1 = parseIsoDate(startIso).getTime();
    const e1 = parseIsoDate(endIso).getTime();
    const s2 = parseIsoDate(range.checkInDate).getTime();
    const e2 = parseIsoDate(range.checkOutDate).getTime();
    return s1 < e2 && e1 > s2;
  }

  function validateAgainstBooked() {
    const roomId = Number(document.getElementById("roomId").value || 0);
    const inD = document.getElementById("checkIn").value;
    const outD = document.getElementById("checkOut").value;

    if (!roomId || !inD || !outD) return true;

    if (outD <= inD) {
      showAlert("form", "Check-out date must be after check-in date.", "warning");
      return false;
    }

    const conflict = bookedRanges.some(r => overlaps(inD, outD, r));
    if (conflict) {
      showAlert("form", "Selected dates overlap with an existing reservation for this room.", "danger");
      return false;
    }
    return true;
  }

  function getRoomRate(room) {
    const v = room?.ratePerNight ?? room?.rate_per_night ?? room?.price ?? room?.rate ?? 0;
    return Number(v || 0);
  }

  function calcNights(checkInIso, checkOutIso) {
    if (!checkInIso || !checkOutIso) return 0;
    const ms = parseIsoDate(checkOutIso).getTime() - parseIsoDate(checkInIso).getTime();
    const n = Math.floor(ms / (1000 * 60 * 60 * 24));
    return n > 0 ? n : 0;
  }

  function round2(n) { return Math.round((Number(n) + Number.EPSILON) * 100) / 100; }

  function renderCalc({ nights, rate, subtotal, total }) {
    document.getElementById("calcNights").value = nights;
    document.getElementById("calcRate").value = rate === "" ? "" : money(rate);
    document.getElementById("calcSubtotal").value = subtotal === "" ? "" : money(subtotal);
    document.getElementById("calcTotal").value = total === "" ? "" : money(total);
  }

  function recalcPricing() {
    const roomId = Number(document.getElementById("roomId").value || 0);
    const room = roomsById.get(String(roomId));
    const inD = document.getElementById("checkIn").value;
    const outD = document.getElementById("checkOut").value;

    if (!roomId || !room) { renderCalc({ nights:"", rate:"", subtotal:"", total:"" }); return; }

    const rate = getRoomRate(room);
    const nights = calcNights(inD, outD);

    if (!inD || !outD || !nights || rate <= 0) {
      renderCalc({ nights: nights ? nights : "", rate: rate > 0 ? rate : "", subtotal:"", total:"" });
      return;
    }

    const subtotal = round2(nights * rate);
    const tax = 0.00;
    const discount = 0.00;
    const total = round2(subtotal + tax - discount);
    renderCalc({ nights, rate, subtotal, total });
  }

  document.getElementById("checkIn").addEventListener("change", () => {
    hideAlert("form");
    const inD = document.getElementById("checkIn").value;
    if (inD) document.getElementById("checkOut").min = inD;
    validateAgainstBooked();
    recalcPricing();
  });

  document.getElementById("checkOut").addEventListener("change", () => {
    hideAlert("form");
    validateAgainstBooked();
    recalcPricing();
  });

  document.getElementById("roomId").addEventListener("change", async () => {
    const room = roomsById.get(String(document.getElementById("roomId").value));
    const meta = document.getElementById("roomMeta");
    if (!room) { meta.textContent = ""; recalcPricing(); return; }

    const rate = getRoomRate(room);
    meta.textContent = `Max guests: ${room.maxGuests ?? 2} | Status: ${room.status} | Rate: ${money(rate)}`;

    await loadBookedRangesForRoom(room.roomId);
    validateAgainstBooked();
    recalcPricing();
  });

  function initGuestSearch() {
    const input = document.getElementById("guestSearch");
    const dl = document.getElementById("guestSuggestions");

    if (input.dataset.bound === "1") return;
    input.dataset.bound = "1";

    input.addEventListener("input", () => {
      clearTimeout(guestSearchTimer);
      guestSearchTimer = setTimeout(async () => {
        const q = input.value.trim();
        document.getElementById("guestId").value = "";

        if (q.length < 3) {
          dl.innerHTML = "";
          lastGuestResults = [];
          return;
        }

        try {
          const res = await fetch(`${BASE}/api/guests/search?q=${encodeURIComponent(q)}`, { credentials: "same-origin" });
          const txt = await res.text();
          let data = {};
          try { data = JSON.parse(txt); } catch(e) {}

          if (!res.ok) { dl.innerHTML = ""; lastGuestResults = []; return; }

          const guests = data.guests || [];
          lastGuestResults = guests;

          dl.innerHTML = guests.map(g => {
            const label = `${g.fullName} | ${g.email || "-"} | ${g.contactNumber || "-"}`;
            return `<option value="${escapeHtml(label)}"></option>`;
          }).join("");

        } catch (e) {
          dl.innerHTML = "";
          lastGuestResults = [];
        }
      }, 350);
    });

    input.addEventListener("change", () => {
      const val = input.value.trim();
      const g = lastGuestResults.find(x => (`${x.fullName} | ${x.email || "-"} | ${x.contactNumber || "-"}`) === val);
      if (!g) return;
      document.getElementById("guestId").value = g.guestId;
      document.getElementById("guestName").value = g.fullName || "";
      document.getElementById("guestEmail").value = g.email || "";
      document.getElementById("guestContactNumber").value = g.contactNumber || "";
    });
  }

  function escapeHtml(s) {
    return String(s)
      .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
  }

  async function loadRoomsDropdown() {
    const sel = document.getElementById("roomId");
    const meta = document.getElementById("roomMeta");

    sel.innerHTML = `<option value="">Loading rooms...</option>`;
    roomsById.clear();
    meta.textContent = "";
    bookedRanges = [];
    document.getElementById("roomBlockedHint").textContent = "";

    try {
      const res = await fetch(`${BASE}/api/rooms`, { credentials: "same-origin" });
      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch(e) {}

      if (!res.ok) {
        showAlert("form", data.message || "Failed to load rooms.", "danger");
        sel.innerHTML = `<option value="">-- No rooms --</option>`;
        return;
      }

      const rooms = data.rooms || [];
      if (!rooms.length) {
        sel.innerHTML = `<option value="">-- No rooms available --</option>`;
        return;
      }

      const available = rooms.filter(r => r.status === "AVAILABLE");
      const list = available.length ? available : rooms;

      sel.innerHTML = `<option value="">Select a room</option>`;
      list.forEach(r => {
        roomsById.set(String(r.roomId), r);
        const rate = getRoomRate(r);
        sel.add(new Option(`${r.roomNumber} - ${r.roomType} - ${money(rate)}`, r.roomId));
      });

      recalcPricing();

    } catch (err) {
      showAlert("form", "Network error loading rooms: " + err.message, "danger");
      sel.innerHTML = `<option value="">-- Failed to load --</option>`;
    }
  }

  async function loadBookedRangesForRoom(roomId) {
    bookedRanges = [];
    document.getElementById("roomBlockedHint").textContent = "";
    if (!roomId) return;

    try {
      const res = await fetch(`${BASE}/api/reservations/by-room?roomId=${encodeURIComponent(roomId)}`, { credentials: "same-origin" });
      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch(e) {}
      if (!res.ok) return;

      bookedRanges = data.bookings || [];
      if (bookedRanges.length) {
        document.getElementById("roomBlockedHint").textContent =
          `Blocked ranges: ` + bookedRanges.slice(0, 3).map(b => `${b.checkInDate} → ${b.checkOutDate}`).join(" , ")
          + (bookedRanges.length > 3 ? " ..." : "");
      }
    } catch (e) {
      bookedRanges = [];
    }
  }

  async function viewReservation(id) {
    try {
      const res = await fetch(`${BASE}/api/reservations/detail?id=${encodeURIComponent(id)}`, { credentials: "same-origin" });
      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch (e) {}

      if (!res.ok) {
        showAlert("page", data.message || "Failed to load reservation detail.", "danger");
        return;
      }

      const r = data.reservation || data.data || data;
      if (!r || typeof r !== "object") {
        showAlert("page", "Invalid detail response from server.", "danger");
        return;
      }

      document.getElementById("vReservationNumber").textContent = r.reservationNumber || "-";
      setStatusBadge(document.getElementById("vStatus"), r.status);

      document.getElementById("vGuestName").textContent = r.guestName || ("Guest #" + (r.guestId ?? "-"));
      document.getElementById("vGuestEmail").textContent = r.guestEmail || "-";
      document.getElementById("vGuestPhone").textContent = r.guestContactNumber || "-";

      document.getElementById("vRoomNumber").textContent = r.roomNumber || ("Room #" + (r.roomId ?? "-"));
      document.getElementById("vDates").textContent = `${r.checkInDate || "-"} → ${r.checkOutDate || "-"}`;
      document.getElementById("vNights").textContent = `Nights: ${r.nights ?? "-"}`;

      document.getElementById("vRate").textContent = money(r.ratePerNight ?? 0);
      document.getElementById("vSubtotal").textContent = money(r.subtotal ?? 0);
      document.getElementById("vTax").textContent = money(r.tax ?? 0);
      document.getElementById("vTotal").textContent = money(r.totalAmount ?? 0);
      document.getElementById("vDiscount").textContent = `Discount: ${money(r.discount ?? 0)}`;

      document.getElementById("vNotes").textContent = r.notes || "-";

      document.getElementById("vEditBtn").onclick = () => {
        bootstrap.Modal.getOrCreateInstance(document.getElementById("viewReservationModal")).hide();
        openEditReservationModal(id);
      };

      document.getElementById("vDeleteBtn").onclick = async () => {
        bootstrap.Modal.getOrCreateInstance(document.getElementById("viewReservationModal")).hide();
        await deleteReservation(id);
      };

      bootstrap.Modal.getOrCreateInstance(document.getElementById("viewReservationModal")).show();

    } catch (e) {
      showAlert("page", "Network error: " + e.message, "danger");
    }
  }

  async function openEditReservationModal(id) {
    const r = reservationsCache.find(x => Number(x.reservationId) === Number(id));
    if (!r) { showAlert("page", "Reservation not found in table.", "warning"); return; }

    resetReservationForm();
    document.getElementById("reservationModalTitle").innerHTML =
      `<i class="fas fa-pen-to-square me-2 text-primary"></i>Edit Reservation`;
    document.getElementById("reservationId").value = r.reservationId;

    await loadRoomsDropdown();
    initGuestSearch();
    lockPastDates();

    document.getElementById("guestId").value = r.guestId || "";
    document.getElementById("guestName").value = r.guestName || "";
    document.getElementById("guestEmail").value = r.guestEmail || "";
    document.getElementById("guestContactNumber").value = r.guestContactNumber || "";

    document.getElementById("roomId").value = r.roomId || "";
    await loadBookedRangesForRoom(r.roomId);

    document.getElementById("checkIn").value = r.checkInDate || "";
    document.getElementById("checkOut").value = r.checkOutDate || "";
    document.getElementById("status").value = r.status || "PENDING";

    recalcPricing();
    bootstrap.Modal.getOrCreateInstance(document.getElementById("reservationModal")).show();
  }

  async function deleteReservation(id) {
    if (!confirm("Delete this reservation?")) return;

    try {
      const res = await fetch(`${BASE}/api/reservations?id=${encodeURIComponent(id)}`, {
        method: "DELETE",
        credentials: "same-origin"
      });

      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch(e) {}

      if (!res.ok) {
        showAlert("page", data.message || "Delete failed.", "danger");
        return;
      }

      showAlert("page", "Reservation deleted.", "success");
      loadReservations();
      if (calendar) calendar.refetchEvents();

    } catch (e) {
      showAlert("page", "Network error: " + e.message, "danger");
    }
  }

  async function saveReservation() {
    hideAlert("form");

    const reservationId = Number(document.getElementById("reservationId").value || 0);
    const roomId = Number(document.getElementById("roomId").value || 0);
    const room = roomsById.get(String(roomId));
    const rate = getRoomRate(room);

    const inD = document.getElementById("checkIn").value;
    const outD = document.getElementById("checkOut").value;
    const nights = calcNights(inD, outD);
    const subtotal = round2(nights * rate);
    const tax = 0.00;
    const discount = 0.00;
    const totalAmount = round2(subtotal + tax - discount);

    const payload = {
      reservationId,
      guestId: Number(document.getElementById("guestId").value || 0),
      guestName: document.getElementById("guestName").value.trim(),
      guestEmail: document.getElementById("guestEmail").value.trim(),
      guestContactNumber: document.getElementById("guestContactNumber").value.trim(),
      roomId,
      checkInDate: inD,
      checkOutDate: outD,
      guestCount: Number(document.getElementById("guestCount").value || 1),
      status: document.getElementById("status").value,
      notes: document.getElementById("notes").value.trim(),
      nights,
      ratePerNight: rate,
      subtotal,
      tax,
      discount,
      totalAmount
    };

    if (!payload.guestName || !payload.guestEmail || !payload.guestContactNumber ||
        !payload.roomId || !payload.checkInDate || !payload.checkOutDate) {
      showAlert("form", "Please fill all required fields.", "warning");
      return;
    }

    const max = room?.maxGuests ?? 2;
    if (payload.guestCount > max) {
      showAlert("form", `Guest count cannot exceed room capacity (${max}).`, "warning");
      return;
    }

    if (!validateAgainstBooked()) return;

    try {
      setSaving(true);
      showAlert("form", reservationId ? "Updating reservation..." : "Saving reservation...", "info");

      const res = await fetch(`${BASE}/api/reservations`, {
        method: reservationId ? "PUT" : "POST",
        credentials: "same-origin",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch(e) {}

      if (!res.ok) {
        showAlert("form", data.message || "Failed to save reservation.", "danger");
        return;
      }

      showAlert("form", reservationId ? "Reservation updated successfully." : "Reservation saved successfully.", "success");

      setTimeout(() => {
        bootstrap.Modal.getOrCreateInstance(document.getElementById("reservationModal")).hide();
        loadReservations();
        if (calendar) calendar.refetchEvents();
      }, 400);

    } catch (err) {
      showAlert("form", "Network error: " + err.message, "danger");
    } finally {
      setSaving(false);
    }
  }

  function renderRecentCheckins() {
    const wrap = document.getElementById("recentCheckins");
    if (!wrap) return;

    const list = (reservationsCache || [])
      .filter(r => String(r.status || "").toUpperCase() === "CHECKED_IN")
      .slice(0, 6);

    document.getElementById("checkInCount").textContent = String(list.length);

    if (!list.length) {
      wrap.innerHTML = `<div class="text-muted">No check-ins yet.</div>`;
      return;
    }

    wrap.innerHTML = list.map(r => `
      <button class="btn btn-light border text-start" type="button" onclick="viewReservation(${r.reservationId})">
        <div class="fw-semibold">${escapeHtml(r.guestName || ("Guest #" + r.guestId))}</div>
        <div class="small text-muted">
          Room ${escapeHtml(r.roomNumber || r.roomId)} • ${r.checkInDate} → ${r.checkOutDate}
        </div>
      </button>
    `).join("");
  }

  function tooltipText(ep, fallbackTitle, startStr, endStr) {
    return [
      `Reservation: ${ep.reservationNumber || fallbackTitle || "-"}`,
      `Guest: ${ep.guestName || "-"}`,
      `Phone: ${ep.guestContactNumber || "-"}`,
      `Room: ${ep.roomNumber || "-"}`,
      `Dates: ${(ep.checkInDate || startStr || "-")} → ${(ep.checkOutDate || endStr || "-")}`,
      `Status: ${ep.status || "-"}`
    ].join("\n");
  }

  function initCalendarIfNeeded() {
    if (calendar) return;

    const el = document.getElementById("bookingsCalendar");
    if (!el) return;

    calendar = new FullCalendar.Calendar(el, {
      initialView: "dayGridMonth",
      height: "auto",

      events: async (info, success, failure) => {
        try {
          const start = info.startStr.slice(0, 10);
          const end = info.endStr.slice(0, 10);
          const res = await fetch(`${BASE}/api/reservations/calendar?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`, {
            credentials: "same-origin"
          });

          const txt = await res.text();
          let data = {};
          try { data = JSON.parse(txt); } catch(e) {}

          if (!res.ok) { failure(data); return; }

          const events = (data.events || []).map(e => ({
            id: e.id,
            title: e.title,
            start: e.start,
            end: e.end,
            extendedProps: e.extendedProps || {}
          }));

          success(events);
        } catch (e) {
          failure(e);
        }
      },

      eventMouseEnter: (info) => {
        const ep = info.event.extendedProps || {};
        info.el.setAttribute("title",
          tooltipText(ep, info.event.title, info.event.startStr, info.event.endStr)
        );

        const t = bootstrap.Tooltip.getOrCreateInstance(info.el, {
          container: "body",
          trigger: "hover",
          placement: "top"
        });
        t.show();
      },

      eventMouseLeave: (info) => {
        const t = bootstrap.Tooltip.getInstance(info.el);
        if (t) t.dispose();
      },

      eventClick: (info) => {
        viewReservation(info.event.id);
      }
    });

    calendar.render();
  }

  async function loadReservations() {
    hideAlert("page");
    tbody.innerHTML = `<tr><td colspan="9" class="text-muted">Loading...</td></tr>`;

    try {
      const res = await fetch(`${BASE}/api/reservations`, { credentials: "same-origin" });
      const txt = await res.text();
      let data = {};
      try { data = JSON.parse(txt); } catch(e) {}

      if (!res.ok) {
        showAlert("page", data.message || "Failed to load reservations.", "danger");
        tbody.innerHTML = `<tr><td colspan="9" class="text-danger">Failed to load.</td></tr>`;
        return;
      }

      const list = data.reservations || [];
      reservationsCache = list;

      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-muted">No reservations found.</td></tr>`;
        renderRecentCheckins();
        return;
      }

      tbody.innerHTML = list.map(r => `
        <tr>
          <td class="fw-semibold">${r.reservationId}</td>
          <td>${escapeHtml(r.guestName || String(r.guestId || ""))}</td>
          <td>${escapeHtml(r.guestEmail || "-")}</td>
          <td>${escapeHtml(r.roomNumber || String(r.roomId || ""))}</td>
          <td>${r.checkInDate}</td>
          <td>${r.checkOutDate}</td>
          <td>
            <span class="badge bg-${
              r.status === 'CONFIRMED' ? 'success' :
              r.status === 'PENDING' ? 'warning' :
              r.status === 'CHECKED_IN' ? 'info' :
              'secondary'
            }">${escapeHtml(r.status || "-")}</span>
          </td>
          <td class="text-end">${(r.totalAmount != null) ? money(r.totalAmount) : "-"}</td>
          <td class="text-end text-nowrap">
            <button class="btn btn-outline-secondary btn-sm" onclick="viewReservation(${r.reservationId})">View</button>
            <button class="btn btn-outline-secondary btn-sm" onclick="openEditReservationModal(${r.reservationId})">Edit</button>
            <button class="btn btn-outline-primary btn-sm"
                onclick="openInvoice(${r.reservationId})">
          Invoice
        </button>

            <button class="btn btn-outline-danger btn-sm" onclick="deleteReservation(${r.reservationId})">Delete</button>
          </td>
        </tr>
      `).join("");

      renderRecentCheckins();
      if (calendar) calendar.refetchEvents();

    } catch (err) {
      showAlert("page", "Network error: " + err.message, "danger");
      tbody.innerHTML = `<tr><td colspan="9" class="text-danger">Failed to load.</td></tr>`;
    }
  }
  
  function openInvoice(reservationId) {
	  const url = BASE + "/api/invoice?reservationId=" + encodeURIComponent(reservationId);
	  window.open(url, "_blank");
	}

</script>
</body>
</html>
